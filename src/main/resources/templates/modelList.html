<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>모델 목록 조회</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
</head>
<body>
<form method="get" th:action="@{/models}" id="search-form">
    <div class="form-row align-items-center">
        <div class="col-auto">
            <label class="sr-only" for="searchKeyword">검색어</label>
            <input type="text" class="form-control" name="searchKeyword" id="searchKeyword" th:value="${param.searchKeyword}" placeholder="검색어"/>
        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-primary">검색</button>
        </div>
    </div>
</form>
<table class="table">
    <thead>
    <tr>
        <th>품목허가번호</th>
        <th>품목명</th>
        <th>모델명</th>
        <th>등급</th>
        <th>허가일자</th>
        <th>등록된 UdiDi 갯수</th>
    </tr>
    </thead>
    <tbody id="models">
    </tbody>
</table>
<div id="udi-di-cont">

</div>
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
<script type="text/template" id="model-row">
    <tr>
        <td>${permitItemNo}</td>
        <td>${meddevItemSeq}</td>
        <td>
            <button class="type-name btn btn-outline-secondary">${modelName}</button>
        </td>
        <td>${grade}</td>
        <td>${permitDate}</td>
        <td>${udidiCount}</td>
    </tr>
</script>

<script type="text/template" id="udi-di-codes-template">
    <table class="table">
        <thead>
        <tr>
            <th>UDI-DI 일련번호</th>
            <th>모델일련번호</th>
            <th>코드구분</th>
            <th>UDI-DI 코드</th>
            <th>포장 내 수량</th>
            <th>통합정보 등록 여부</th>
            <th>통합정보 등록 완료일</th>
        </tr>
        </thead>
        <tbody id="udi-di-code-list">
        </tbody>
    </table>
</script>
<script type="text/template" id="udi-di-codes-row-template">
    <tr>
        <td>${udiDiSeq}</td>
        <td>${mebTypeSeq}</td>
        <td>${codeSystemFlag}</td>
        <td>
            <button class="udiDiCode btn btn-outline-secondary">${udiDiCode}</button>
        </td>
        <td>${packQuantity}</td>
        <td>${unityInfoRegisted}</td>
        <td>${unityInfoRegistComptDate}</td>
    </tr>
</script>
<script type="text/javascript" th:inline="javascript" th:if="${models}">
    /*<![CDATA[*/
    (function() {
        function loadTemplate(id) {
            return document.getElementById(id).innerHTML;
        }

        function replaceTemplate(templateStr, data) {
            var result = templateStr;
            for (var key in data) {
                result = result.replace('\${' + key + '}', data[key]);
            }
            return result;
        }

        function fetchUdiDiCodes(model, onFetchSuccess) {
            $.ajax({
                url: '/udi',
                method: 'GET',
                data: {
                    'meddevItemSeq': model.meddevItemSeq,
                    'mebTypeName': model.modelName,
                    'isForExport': model.isForExport
                },
                success: function (udiDis) {
                    console.log(udiDis);
                    onFetchSuccess.apply(null, [udiDis]);
                },
                error: function (err) {
                    console.error(err);
                }
            });
        }

        function renderUdiDiCodes(udiDis, onUdiDiCodeClick) {
            $('#udi-di-cont').empty();
            var $udiDiCodes = $(loadTemplate('udi-di-codes-template'));
            var tbody = $udiDiCodes.find('#udi-di-code-list');
            $udiDiCodes.append(tbody);
            $('#udi-di-cont').append($udiDiCodes);
            var udiDiRowTemplate = loadTemplate('udi-di-codes-row-template');
            udiDis.items.forEach(function (udiDi) {
                var udiDiRow = $(replaceTemplate(udiDiRowTemplate, udiDi));
                udiDiRow.find('.udiDiCode').click(function (e) {
                    e.preventDefault();
                    onUdiDiCodeClick.apply(this, [udiDi]);
                });
                tbody.append(udiDiRow);
            });
        }

        function renderUdiDiCodeForm(udiDi) {
            // TODO UDI 통합정보 작성 폼 렌더링
            console.log(udiDi);
        }


        var models = /*[[${models.items}]]*/ [];
        var $models = $('#models');
        var modelsTemplate = loadTemplate('model-row');

        models.forEach(function (model) {
            var row = $(replaceTemplate(modelsTemplate, model));
            row.find('.type-name').click(function(e) {
                e.preventDefault();
                fetchUdiDiCodes(model, function(udiDis) {
                    renderUdiDiCodes(udiDis, renderUdiDiCodeForm);
                });
            });
            $models.append(row);
        });
    })();
    /*]]>*/
</script>
</body>
</html>
